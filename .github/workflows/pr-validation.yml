name: PR Validation

on:
  pull_request:
    branches: [ main, dev/** ]
    paths:
      - 'data/monsters/**'
      - 'src/**'
      - 'tests/**'
      - 'scripts/**'

jobs:
  validate-changes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.12.0'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check for monster data changes
      id: changes
      run: |
        if git diff --name-only origin/main...HEAD | grep -q "data/monsters/"; then
          echo "monster_changes=true" >> $GITHUB_OUTPUT
        else
          echo "monster_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Validate monster data changes
      if: steps.changes.outputs.monster_changes == 'true'
      run: |
        echo "## Monster Data Validation Results 🐉" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Changes detected in monster data files. Running validation..." >> $GITHUB_STEP_SUMMARY
        npm run test:run
        
    - name: Check formatting consistency
      if: steps.changes.outputs.monster_changes == 'true'
      run: |
        npm run format-monsters:dry-run > format-check.txt || true
        if grep -q "changes needed" format-check.txt; then
          echo "⚠️ **Formatting inconsistencies found**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run \`npm run format-monsters\` to fix formatting issues." >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ **All monster data properly formatted**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Run all tests
      run: npm run test:run